<!doctype html>
<html lang="en">
  <head>
    <title>WiiU Video</title>
    <meta charset="utf-8">
    <meta name="viewport" content="minimum-scale=1,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="style/wiivid.css" rel="stylesheet" type="text/css">
    <!-- <script src="http://code.jquery.com/jquery-latest.min.js"></script> -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
    <script src="/nowjs/now.js"></script>
    <script src="http://popcornjs.org/code/dist/popcorn-complete.js"></script>
    <script>
    //var mediapath='../video';
    var data=-1;
    var recent=-1;
    var vidSearchResults=new Array();
    var playing=false;
    var currentVid=-1;
    var volume=0;
    //var tempvar;
    var popcorn=-1;
    var needResponse=false;
    $(document).ready(function(){
      popcorn=Popcorn('#video');
      initLayout();
      resizePage();
      /*
      $('#content').height($(window).height()-$('#banner').height());
      $('#list').height($('#content').height()-$('#recent').height());
      popcorn.video.height=$(window).height()/3;
      popcorn.video.width=popcorn.video.height*1.8;
      */
      now.ready(function(){
        now.sGetList();
        now.sGetRecent();
        initData();
        showRecent();
        // http://popcornjs.org/popcorn-docs/events/
        popcorn.on('abort',function(){
          console.log('abort');
        });
        popcorn.on('dataunavailable',function(){
          console.log('dataunavailable');
        });
        popcorn.on('durationchange',function(){
          console.log('durationchange');
        });
        popcorn.on('ended',function(){
          console.log('video has ended');
        });
        popcorn.on('emptied',function(){
          console.log('emptied');
          playing=false;
        });
        popcorn.on('empty',function(){
          console.log('empty');
        });
        popcorn.on('ended',function(){
          console.log('ended');
        });
        popcorn.on('error',function(event){
          // http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#error-codes
          console.log('error');
          console.log(event.srcElement.error);
        });
        popcorn.on('loadeddata',function(){
          console.log('loadeddata');
        });
        popcorn.on('loadedmetadata',function(){
          console.log('loadedmetadata');
          setTimePlayed();
        });
        popcorn.on('pause',function(){
          console.log('pause');
          playing=false;
        });
        popcorn.on('playing',function(event){
          console.log('playing');
          playing=true;
          
        });
        popcorn.on('progress',function(event){
          //console.log('progress');
        });
        popcorn.on('suspend',function(){
          //console.log('suspend');
        });
        popcorn.on('timeupdate',function(){
          //console.log('timeupdate');
        });
        popcorn.on('waiting',function(){
          console.log('waiting');
        });
      });
      now.cGetData=function(val){
        data=val;
      }
      now.cCreateDirectoryList=function(tree){
        pageConsole('cCreateDirectoryList called from '+now.core.clientId);
        data=tree;
        $('#toplevelDirs').empty();
        $('#toplevelDirs').nextAll().empty();
        $('#toplevelDirs').nextAll().remove();
        $('#vidsDiv').empty();
        $.each(tree.subdirs,function(key,obj){
          if(obj.subdirs!=undefined)buildDivTree(obj,$('#toplevelDirs'),true);
        });
        // handle top level videos
        /*
        $.each(tree.vids,function(key,obj){
          buildDivTree(obj,$('#list'),false);
        });
        */
      };
      now.cGetRecent=function(val){
        recent=val;
      }
      function vidSearch(url,array){
        //vidSearchResults=new Array();
        var result=-1;
        _vidSearch(url,array);
        //for(var i=0;i<vidSearchResults.length;i++){
        $.each(vidSearchResults,function(key,val){
          if(val!=undefined)result=val;
        });
        return result;
      }
      function _vidSearch(url,array){
        if(array==undefined)array=data.subdirs;
        //console.log('_vidSearch: '+url);
        //console.log(JSON.stringify(array));
        for(var i=0;i<array.length;i++){
          if(url.indexOf(array[i].url)>-1){
            //console.log('found directory: '+array[i].url);
            for(var j=0;j<array[i].vids.length;j++){
              if(url==array[i].vids[j].url){
                //console.log('found match');
                addVidResult(array[i].vids[j]);
              }
            }
            vidSearch(url,array[i].subdirs);
          }
        }
      }
      function addVidResult(val){
        vidSearchResults.push(val);
      }
      function buildDivTree(obj,parentDiv,isDir){
        var div={};
        if(isDir){
          div=jQuery('<div/>',{text:obj.name}).appendTo(parentDiv).addClass('dirDiv');
          div.on('click',function(event){
            event.stopPropagation();
            // display dirs 
            parentDiv.nextAll().empty();
            parentDiv.nextAll().remove();
            if(obj.subdirs.length>0){
              // display subdirs
              var subdirsdiv=jQuery('<div/>',{}).addClass('dirsDiv');
              subdirsdiv.appendTo(parentDiv.parent());
              $.each(obj.subdirs,function(key,subdir){
                buildDivTree(subdir,subdirsdiv,true);
              });
            }
            if(div.siblings().first().hasClass('hiddenDir')){
              div.siblings().removeClass('hiddenDir');
              parentDiv.nextAll().empty();
              parentDiv.nextAll().remove();
            }else{
              div.siblings().addClass('hiddenDir');
            }
            if(obj.vids.length>0){
              // display vids 
              $('#vidsDiv').empty();
              $.each(obj.vids,function(key,vid){
                buildDivTree(vid,$('#vidsDiv')[0],false);
              });
            }
          });
        }
        else{ // vid 
          div=jQuery('<div/>',{text:obj.name}).appendTo(parentDiv).addClass('vidDiv');
          div.on('click',function(event){
            event.stopPropagation();
            // handle WiiU window size change 
            if(navigator.userAgent.indexOf('Nintendo WiiU')>0)resizePage();
            currentVid=obj;
            $($('video').children()[0]).attr('src',obj.url);
            popcorn.load();
            popcorn.play();
            now.sAddRecent(obj.url);
            saveTimePlayed();
            tempvar=popcorn;
          });
          div.on('dragstart',function(){
            console.log('dragstart');
            //clearTimeout(mousedownTimeout);
          });
          div.on('mouseup touchend',function(){
            console.log('mouseup/touchend');
            //clearTimeout(mousedownTimeout);
          });
        }
      }
      function initData(){
        //console.log(recent+' and '+data);
        if(recent==-1||data==-1){
          setTimeout(initData,100);
        }else console.log('data initialized');
      }
      function showRecent(){
        if(recent==-1||data==-1)setTimeout(showRecent,100);
        else{
          $('#vidsDiv').empty();
          //console.log('recent vids length: '+recent.vids.length);
          $.each(recent.vids,function(key,vidurl){
            var vid=vidSearch(vidurl);
            buildDivTree(vid,$('#vidsDiv')[0],false);
          });
        }
      }
      function addDirEvents(){
        // touchstart, touchend, touchmove, touchcancel
      }
      function addVidEvents(){
        // touchstart, touchend, touchmove, touchcancel
      }
      function setTimePlayed(){
        $('#video')[0].currentTime=currentVid.timePlayed;
        //popcorn.media.currentTime=currentVid.timePlayed;
      }
      function saveTimePlayed(){
        if(playing){
          currentVid.timePlayed=$('#video')[0].currentTime;
          //console.log('saving time');
          //now.sBackup(data,currentVid);
          now.sBackup(currentVid);
        }
        setTimeout(saveTimePlayed,3000);
      }
    });
    window.onresize=function(){
      resizePage();
    }
    function initLayout(){
      if(navigator.userAgent.indexOf('Nintendo WiiU')>0){
        $('#console')[0].style.top='auto';
        $('#console')[0].style.bottom='0px';
      }
      $('#banner').on('click',function(event){
        pageConsole('banner click');
        $('#toplevelDirs').nextAll().last().empty();
        $('#toplevelDirs').nextAll().last().remove();
        var selectedDir=-1;
        if($('#toplevelDirs').nextAll().last().children().not('.hiddenDir').length==1){
          console.log($('#toplevelDirs').nextAll().last().children().not('.hiddenDir'));
        }
        /*
        // display vids 
        $('#vidsDiv').empty();
        $.each(subdir.vids,function(key,vid){
          buildDivTree(vid,$('#vidsDiv')[0],false);
        });
        */
      });
      $('#vidsDiv').draggable({axis:'y'});
      $('#vidsDiv').on('dragstart',function(event){
        pageConsole('list dragstart/touchmove');
      });
    }
    function resizePage(){
      //$('body').height($(window).height());
      pageConsole('window height: '+$(window).height());
      $('#footer').width($(window).width()-20);
      if(navigator.userAgent.indexOf('Nintendo WiiU')>0){
        // TODO remove once video is in detail overlay
        $('#video')[0].style.display='none';
        var vpString=$('meta[name=viewport]').attr('content');
        var vpHeight=-1;
        if($(window).height()>400){
          // initial WiiU resize 
          vpHeight=400;
        }
        if($(window).height()==400){
          // WiiU resize when getting ready for vid playback 
          vpHeight=350;
        }
        pageConsole(vpHeight);
        if(vpString.indexOf('height')==-1)vpString+=',height='+vpHeight;
        else vpString=vpString.substring(0,vpString.indexOf('height')+7)+vpHeight;
        $('meta[name=viewport]').attr('content',vpString);
      }
      var remainder=$('#banner').height()*2;
      $('#content').height($(window).height()-remainder);
      $('#list').height($('#content').height()-$('#recent').height());
      popcorn.video.height=$(window).height()/3;
      popcorn.video.width=popcorn.video.height*1.8;
      //$('#userAgent').text(navigator.userAgent); 
    }
    function pageConsole(text){
      jQuery('<div/>',{
        id:'consoleDiv',
        text:text
      }).addClass('consoleText').appendTo($('#console'));
      if($('#console').children().length>8){
        $('#console')[0].empty();
        $('#console')[0].remove();
      }
    }
    function toggleVolume(vol){
      if(vol!=0){
        volume=document.getElementById('video').volume;
        document.getElementById('video').volume=0;
      }else document.getElementById('video').volume=volume;
    }
    function fullscreen(){
      console.log('fullscreen');
      $('body')[0].webkitRequestFullScreen();
    }
    //document.addEventListener('DOMContentLoaded',function(){},false);
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="toplevelDirs" class="dirsDiv"></div>
    </div>
    <div id="content">
      <div id="list">
        <div id="vidsDiv" class="vidsDiv"></div>
      </div>
      <div id="footer">
        <video id="video" controls>
          <source src=""></source>
          Please update your browser (video element is unsupported).
        </video>
      </div>
      <div id="vidcontrols" style="display:none;">
        <button onclick="document.getElementById('video').play()">Play</button>
        <button onclick="document.getElementById('video').pause()">Pause</button>
        <button onclick="document.getElementById('video').volume+=0.1">Volume+</button>
        <button onclick="toggleVolume(document.getElementById('video').volume);">Mute</button>
        <button onclick="document.getElementById('video').volume-=0.1">Volume-</button>
        <!-- <button onclick="document.getElementById('video').pause();document.getElementById('video').src='';">Stop</button> -->
        <button onclick="document.getElementById('video').pause();">Stop</button>
      </div>
      <!-- <div id="footnote" style="display:none;"></div> -->
    </div>
    <div id="console"></div>
    <div id="fullscreen" onclick="fullscreen();">Request fullscreen</div>
  </body>
</html>