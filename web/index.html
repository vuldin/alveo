<!doctype html>
<html lang="en">
  <head>
    <title>WiiU Video</title>
    <meta charset="utf-8">
    <link href="style/wiivid.css" rel="stylesheet" type="text/css">
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="/nowjs/now.js"></script>
    <script src="http://popcornjs.org/code/dist/popcorn-complete.js"></script>
    <script>
    //var mediapath='../video';
    //var progress=0;
    //var playing=false;
    var currentVid=-1;
    var isPlaying=false;
    var volume=0;
    $(document).ready(function(){
      var popcorn=Popcorn('#video');
      now.ready(function(){
        now.sGetList();
        popcorn.footnote({
          /*
          start:2,
          end:5,
          target:'footnote',
          text:'Pop!'
          */
        });
        // http://popcornjs.org/popcorn-docs/events/
        popcorn.on('dataunavailable',function(){
          console.log('dataunavailable');
        });
        popcorn.on('durationchange',function(){
          console.log('durationchange');
        });
        popcorn.on('ended',function(){
          console.log('video has ended');
          playing=false;
        });
        popcorn.on('emptied',function(){
          console.log('emptied');
          playing=false;
        });
        popcorn.on('empty',function(){
          console.log('empty');
          isPlaying=false;
        });
        popcorn.on('ended',function(){
          console.log('ended');
          isPlaying=false;
        });
        popcorn.on('error',function(event){
          // http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#error-codes
          if(event.srcElement.error.code!=4){
            console.log('error');
            console.log(event.srcElement.error);
          }
        });
        popcorn.on('loadeddata',function(){
          //console.log('loadeddata');
        });
        popcorn.on('loadedmetadata',function(){
          //console.log('loadedmetadata');
        });
        popcorn.on('playing',function(event){
          console.log('playing');
          isPlaying=true;
        });
        popcorn.on('progress',function(event){
          //console.log(currentVid.path);
          //console.log($('#video')[0].currentTime);
        });
        popcorn.on('suspend',function(){
          //console.log('suspend');
        });
        popcorn.on('waiting',function(){
          console.log('waiting');
          isPlaying=false;
        });
      });
      now.cCreateDirectoryList=function(tree){
        //console.log(tree);
        $('#list').empty();
        $.each(tree.subdirs,function(key,obj){
          if(obj.subdirs!=undefined)buildDivTree(obj,$('#list'),true);
        });
        // handle top level videos
        $.each(tree.vids,function(key,obj){
          buildDivTree(obj,$('#list'),false);
        });
      };
      now.cVidSearch=function(vid){
        // sets currentVid variable (called from sVidSearch(url))
        currentVid=vid;
        //console.log('cVidSearch');
        //console.log(currentVid);
      };
      function buildDivTree(obj,parentDiv,isDir){
        var div={};
        if(isDir){
          div=jQuery('<div/>',{text:obj.name+' (subdirs: '+obj.subdirs.length+', vids: '+obj.vids.length+')'}).appendTo(parentDiv);
          div.addClass('dirDiv');
          var togglediv=jQuery('<div/>',{}).addClass('toggleDiv');
          var subdirsdiv=jQuery('<div/>',{}).addClass('subdirsDiv');
          var vidsdiv=jQuery('<div/>',{}).addClass('vidsDiv');
          div.on('click',function(event){
            event.stopPropagation();
            if(subdirsdiv[0].children.length==0&&vidsdiv[0].children.length==0){
              togglediv.appendTo(div);
              subdirsdiv.appendTo(togglediv);
              vidsdiv.appendTo(togglediv);
              $.each(obj.subdirs,function(key,subdir){
                buildDivTree(subdir,subdirsdiv,true);
              });
              $.each(obj.vids,function(key,vid){
                buildDivTree(vid,vidsdiv,false);
              });
            }else{
              subdirsdiv.empty().remove();
              vidsdiv.empty().remove();
              togglediv.empty().remove();
            }
          }); // end click function
        }
        else{
          div=jQuery('<div/>',{text:obj.name}).appendTo(parentDiv);
          div.addClass('vidDiv');
          div.on('click',function(event){
            event.stopPropagation();
            $($('video').children()[0]).attr('src',obj.url);
            popcorn.load();
            popcorn.play();
            now.sVidSearch(decodeURI(popcorn.media.currentSrc));
            recTimePlayed(obj);
          });
        }
      }
      function recTimePlayed(vid){
        console.log(getPlayStatus());
        if(isPlaying){
          console.log('recTimePlayed');
          //now.sRecTimePlayed(vid,$('#video')[0].currentTime);
          vid.timePlayed=$('#video')[0].currentTime;
          console.log(vid.url+' at '+vid.timePlayed);
          now.sBackup(top);
          setTimeout(recTimePlayed,10000);
        }
      }
      /*
      function recTimePlayed(){
        console.log(getPlayStatus());
        if(getPlayStatus()){
          console.log('recTimePlayed');
          //now.sRecTimePlayed(vid,$('#video')[0].currentTime);
          currentVid.timePlayed=$('#video')[0].currentTime;
          console.log(currentVid.url+' at '+currentVid.timePlayed);
          now.sBackup(top);
          setTimeout(recTimePlayed,10000);
        }
      }
      */
      /*
      function vidSearchWait(){
        if(getSearchCount()>0){
          console.log('waiting on vidSearch');
          setTimeout(vidSearchWait, 200);
        }
      }
      */
      //$('#userAgent').text(navigator.userAgent);
      if(navigator.userAgent.indexOf('Nintendo WiiU')>0){
        $('body')[0].style.background='#39414A';
        $('body')[0].style.color='#FFFFFF';
        $('#video')[0].style.display='none';
      }
    });
    function getPlayStatus(){
      return isPlaying;
    }
    function toggleVolume(vol){
      if(vol!=0){
        volume=document.getElementById('video').volume;
        document.getElementById('video').volume=0;
      }else document.getElementById('video').volume=volume;
    }
    //document.addEventListener('DOMContentLoaded',function(){},false);
    </script>
  </head>
  <body>
    <video id="video" height="180" width="300" controls>
      <source src=""></source>
      Please update your browser (video element is unsupported).
    </video>
    <div>
      <button onclick="document.getElementById('video').play()">Play</button>
      <button onclick="document.getElementById('video').pause()">Pause</button>
      <button onclick="document.getElementById('video').volume+=0.1">Volume+</button>
      <button onclick="toggleVolume(document.getElementById('video').volume);">Mute</button>
      <button onclick="document.getElementById('video').volume-=0.1">Volume-</button>
      <button onclick="document.getElementById('video').pause();document.getElementById('video').src='';">Stop</button>
    </div>
    <div id="footnote"></div>
    <div id="list">
      <span>Your list is empty.</span>
    </div>
  </body>
</html>