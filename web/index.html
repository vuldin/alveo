<!doctype html>
<html lang="en">
  <head>
    <title>WiiU Video</title>
    <meta charset="utf-8">
    <meta name="viewport" content="minimum-scale=1,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="style/wiivid.css" rel="stylesheet" type="text/css">
    <!-- <script src="http://code.jquery.com/jquery-latest.min.js"></script> -->
    <!--
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
    <script src="http://popcornjs.org/code/dist/popcorn-complete.js"></script>
    -->
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/popcorn-complete.js"></script>
    <script src="/nowjs/now.js"></script>
    <script>
    var data=-1; // main data containing all directory and video information 
    var recent=-1; // recently played video url list 
    //var vidDetails=-1; // result from server of a request for video metadata 
    var vidsDivTop=0;
    var dirSearchResults=new Array();
    var vidSearchResults=new Array();
    var playing=false;
    var currentVid=-1;
    //var mediaserverUrl=-1;
    var volume=0;
    var popcorn=-1;
    var mousedownTimeout=null;
    var drag=false;
    var initialDir=null;
    $(document).ready(function(){
      console.log('document.ready');
      popcorn=Popcorn('#video');
      addPopcornEvents();
      initLayout();
      resizePage();
      initialDir=$('#initialDir');
      now.ready(function(){
        console.log('now.ready');
        now.sGetData();
        now.sGetRecent();
        //now.sGetMediaServerUrl();
        initData();
        initialDir.on('mouseup',function(event){
          event.stopPropagation();
          initialDir.detach();
          createDirectoryList();
        });
        populateVids();
      });
      now.cGetData=function(val){
        console.log('new data variable from server');
        data=val;
      }
      now.cGetRecent=function(val){
        console.log('new recent variable from server');
        recent=val;
      }
      /*
      now.cGetVidDetails=function(val){
        console.log('new vidDetails variable from server');
        vidDetails=val;
      }
      now.cGetMediaServerUrl=function(val){
        if(mediaserverUrl!=val){
          console.log('new mediaserverURL variable from server');
          mediaserverUrl=val;
        }
      }
      */
      function initData(){
        if(recent==-1||data==-1){
          setTimeout(initData,100);
        }else console.log('data initialized');
      }
      function addDirEvents(){
        // touchstart, touchend, touchmove, touchcancel
      }
      function addVidEvents(){
        // touchstart, touchend, touchmove, touchcancel
      }
    });
    window.onresize=function(){
      resizePage();
    }
    function createDirectoryList(){
      if(data==-1)setTimeout(createDirectoryList,100);
      else{
        console.log('createDirectoryList');
        $('#toplevelDirs').empty();
        $('#toplevelDirs').nextAll().empty();
        $('#toplevelDirs').nextAll().remove();
        $.each(data.subdirs,function(key,dir){
          if(dir.subdirs!=undefined)buildDivTree(dir,$('#toplevelDirs'),true);
        });
      }
    }
    now.cShowVids=function(dir){
      console.log('cShowVids server sent vids for '+dir.name);
      //if(dir!=undefined&&dir!=-1&&dir.vids.length>0){ // given directory contains vids
      if(dir.vids.length>0){
        $.each(dir.vids,function(key,vid){
          buildDivTree(vid,vidsDiv,false);
        });
      }else{
        vidsDivTop+=-19; // TODO dynamically find div height and add to cumulative vidsDivTop variable 
        jQuery('<div/>',{text:'Recent shows:'}).appendTo(vidsDiv).addClass('RecentVidsMsgDiv');
        $.each(recent.vids,function(key,recentvid){
          buildDivTree(recentvid,vidsDiv,false);
        });
      }
      setVidsDivTop(getVidsDivHeight());
    }
    function populateVids(dir){
      if(recent==-1||data==-1){
        setTimeout(populateVids,100);
      }else{
        //console.log('populateVids');
        vidsDivTop=0;
        vidsDiv=$('#vidsDiv');
        vidsDiv.css('position','relative');
        vidsDiv.css('top',$(window).height());
        vidsDiv.css('display','block');
        vidsDiv.empty();
        if(dir&&dir.vids.length>0){
          console.log('populateVids: given directory contains vids '+dir.vids.length); 
          $.each(dir.vids,function(key,vid){
            buildDivTree(vid,vidsDiv,false);
          });
        }else{ // display recent vids 
          if(dir!=undefined){
            vidsDivTop+=-19;
            jQuery('<div/>',{text:'No videos found in this directory.'}).appendTo(vidsDiv).addClass('noVidsMsgDiv');
          }
          if(recent.vids.length>0){
            vidsDivTop+=-19;
            jQuery('<div/>',{text:'Recently viewed videos:'}).appendTo(vidsDiv).addClass('RecentVidsMsgDiv');
          }
          $.each(recent.vids,function(key,recentvid){
            buildDivTree(recentvid,vidsDiv,false);
          });
        }
        setVidsDivTop(getVidsDivHeight());
      }
    }
    function showVidDetails(vid){
      // TODO 
      $('#vidDetails').empty();
      vidnameDiv=jQuery('<div/>',{text:vid.name}).appendTo($('#vidDetails')).addClass('vidDetails');
      var vidombdDiv=jQuery('<div/>').appendTo($('#vidDetails')).addClass('vidDetails');
      if(vid.omdb!=-1)vidomdbDiv.text(vid.omdb);
      if(vid.omdbResults!=-1){
        $.each(vid.omdbResults,function(key,val){
          jQuery('<div/>',{text:val}).appendTo($('#vidDetails')).addClass('vidDetails');
        });
      }
      if(vid.omdbError!=-1)vidomdbDiv.text(vid.omdbError);
      $($('video').children()[0]).attr('src',vid.url);
      popcorn.load();
      $('#banner').css('display','none');
      resizePage();
    }
    function getVidsDivHeight(){
      var total=0;
      var vidDivCount=0;
      for(var i=0;i<vidsDiv.children().length;i++){
        if($(vidsDiv.children()[i]).hasClass('vidDiv')){
          if(vidDivCount==0){
            //console.log('increasing content height by '+$(vidsDiv.children()[i]).outerHeight());
            total+=$(vidsDiv.children()[i]).outerHeight();
          }
          vidDivCount++;
          if(vidDivCount==13){
            // TODO base this on window width instead of 13 video divs 
            vidDivCount=0;
          }
        }
      }
      return total;
    }
    function setVidsDivTop(vidsDivHeight){
      console.log('setVidsDivTop');
      vidsDivTop=$('#list').height()/2-vidsDivHeight/2+vidsDivTop;
      if(vidsDivTop<0)vidsDivTop=0;
      vidsDiv.css('top',vidsDivTop);
    }
    function dirSearch(url,array){
      var result=-1;
      _dirSearch(url,array);
      $.each(dirSearchResults,function(key,val){
        if(val!=undefined)result=val;
      });
      return result;
    }
    function _dirSearch(url,array){
      if(array==undefined)array=data.subdirs;
      $.each(array,function(dirkey,dir){
        if(url==dir.url)addResult(dir,dirSearchResults);
        dirSearch(url,dir.subdirs);
      });
    }
    function vidSearch(url,array){
      var result=-1;
      _vidSearch(url,array);
      $.each(vidSearchResults,function(key,val){
        if(val!=undefined)result=val;
      });
      return result;
    }
    function _vidSearch(url,array){
      if(array==undefined)array=data.subdirs;
      $.each(array,function(dirkey,dir){
        if(url.indexOf(dir.url)>-1){
          $.each(dir.vids,function(vidkey,vid){
            if(url==vid.url)addResult(vid,vidSearchResults);
          });
          vidSearch(url,dir.subdirs);
        }
      });
    }
    function addResult(val,array){
      array.push(val);
    }
    function buildDivTree(obj,parentDiv,isDir){
      var div={};
      if(isDir){ // dir 
        div=jQuery('<div/>',{text:obj.name}).appendTo(parentDiv).addClass('dirDiv');
        div.on('mouseup',function(event){
          event.stopPropagation();
          parentDiv.nextAll().empty();
          parentDiv.nextAll().remove();
          if(div.hasClass('selectedDir')){
            div.removeClass('selectedDir');
            div.siblings().removeClass('hiddenDir');
          }
          else{
            div.addClass('selectedDir');
            div.siblings().addClass('hiddenDir');
            if(obj.subdirs.length>0){ // display subdirs 
              var subdirsdiv=jQuery('<div/>',{}).addClass('dirsDiv');
              subdirsdiv.appendTo(parentDiv.parent());
              var left=subdirsdiv.prev().children('.selectedDir').offset().left+subdirsdiv.prev().width()-6;
              subdirsdiv.css('left',left);
              subdirsdiv.css('z-index',subdirsdiv.prev().css('z-index')-1);
              $.each(obj.subdirs,function(key,subdir){
                buildDivTree(subdir,subdirsdiv,true);
              });
            }
          }
          /*
          //div.siblings().toggle();
          div.siblings().slideToggle();
          console.log('subdirs length: '+obj.subdirs.length);
          var hiddenSiblings=div.siblings().filter(function(){
          }else{
            return $(this).css('display') == 'none';
          });
          */
          populateVids(obj);
        });
      }
      else{ // vid 
        //div=jQuery('<div/>',{text:obj.name}).appendTo(parentDiv).addClass('vidDiv');
        div=jQuery('<div/>').appendTo(parentDiv).addClass('vidDiv');
        jQuery('<div/>',{text:obj.title}).appendTo(div).addClass('vidTitleDiv');
        jQuery('<div/>',{text:obj.series}).appendTo(div).addClass('vidSeriesDiv');
        //jQuery('<div/>',{text:'season '+obj.season}).appendTo(div).addClass('vidSeasonDiv');
        //jQuery('<div/>',{text:'(episode '+obj.episode+')'}).appendTo(div).addClass('vidEpisodeDiv');
        div.on('mousedown',function(event){
          mousedownTimeout=setTimeout(function(){
            drag=false;
          },1000);
        });
        div.on('mouseup',function(event){
          if(!drag){
            event.stopPropagation();
            console.log('buildDivTree: '+obj.name);
            showVidDetails(obj);
            //playVid(obj);
          }
        });
      }
    }
    function playVid(obj){
      // handle WiiU window size change 
      if(navigator.userAgent.indexOf('Nintendo WiiU')>0)resizePage();
      currentVid=vidSearch(obj.url);
      //$($('video').children()[0]).attr('src',obj.url);
      if($($('video').children()[0]).attr('src')!=obj.url){ // this likely was already set in showVidDetails 
        $($('video').children()[0]).attr('src',obj.url);
        popcorn.load();
      }
      popcorn.play();
      now.sAddRecent(obj);
      setTimePlayed();
      setDuration();
    }
    function isEpisode(val){
      return val.match(/\s-\s[Ss][0-9]{2,3}[Ee][0-9]{2,3}[Ee]{0,1}[0-9]{0,3}\s-\s/);
    }
    function setTimePlayed(){
      if(playing){
        console.log('setTimePlayed: '+popcorn.media.currentTime);
        currentVid.timePlayed=popcorn.media.currentTime;
        now.sBackup(currentVid);
      }
      setTimeout(setTimePlayed,3000);
    }
    function setDuration(){
      if(!playing)setTimeout(setDuration,2000);
      else{
        if(currentVid.duration==0)currentVid.duration=popcorn.media.duration;
        now.sBackup(currentVid);
      }
    }
    function initLayout(){
      console.log('initLayout');
      if(navigator.userAgent.indexOf('Nintendo WiiU')>0){
        $('#console')[0].style.top='auto';
        $('#console')[0].style.bottom='0px';
      }
      $('#banner').on('mouseup',function(event){
        event.stopPropagation();
        //pageConsole('banner mouseup');
        //console.log($('#toplevelDirs').nextAll());
        //console.log($('#toplevelDirs').nextAll().last());
        //$('#toplevelDirs').nextAll().last().empty();
        //$('#toplevelDirs').nextAll().last().remove();
        //console.log($('#toplevelDirs').nextAll().last());
        //var selectedDir=-1; 
        //var prevurl=mediaserverUrl; 
        /*
        prevurl=data.url;
        $.each($('#toplevelDirs').parent().children().children().not('.hiddenDir'),function(key,val){
          prevurl+=val.innerHTML+'/';
        });
        prevurl=prevurl.substring(0,prevurl.length-1);
        var prevdir=dirSearch(prevurl);
        //var prevdir=data.find({url:prevurl});
        populateVids(prevdir);
        */
        //console.log($('#toplevelDirs').siblings().last().children().not('.hiddenDir'));
        //$($('#toplevelDirs').siblings().last().children().not('.hiddenDir')[0]).mouseup();
        //var prevDir=$($('#toplevelDirs').siblings().last().prev().children().not('.hiddenDir')[0]);
        var prevDir=$('#toplevelDirs').siblings().last().prev().children('.selectedDir');
        //prevDir.mouseup();
        if(prevDir.text().length>0){
          console.log('initlayout: displaying '+prevDir.text()+' vids');
          prevDir.mouseup();
        }else{
          console.log('initlayout: resetting');
          initialDir.detach(); // make sure initialDir isn't attached before emptying parent or it will lose event handling 
          $('#toplevelDirs').empty();
          initialDir.appendTo($('#toplevelDirs'));
          populateVids();
        }
      });
      $('#vidsDiv').draggable({axis:'y'});
      $('#vidsDiv').on('dragstart',function(event){
        drag=true;
        pageConsole('list dragstart/touchmove');
        clearTimeout(mousedownTimeout);
        if($('#toplevelDirs').nextAll().last().children('.hiddenDir').length==0){ // last dirlist isn't being used... remove it 
          $('#toplevelDirs').nextAll().last().empty();
          $('#toplevelDirs').nextAll().last().remove();
        }
      });
      $('#vidsDiv').on('dragstop',function(event){
        console.log($(this).css('top'));
        //if($(this).css('top').substring(0,$(this).css('top').length-2)<0){
        if($(this).css('top').substring(0,$(this).css('top').length-2)<$('#banner').height()+10){
          // TODO handle transition to bottom of vidsDiv taking into account -top value, vidsDiv height, and list height 
          //console.log('initLayout: vidsDiv height is '+getVidsDivHeight());
          //console.log('initLayout: list height is '+$('#list').height());
          if($('#list').height()<getVidsDivHeight())console.log('vidsDiv is not fully shown');
          $(this).css('transition','top 300ms ease-in-out');
          $(this).css('-webkit-transition','top 300ms ease-in-out');
          //$(this).css('top','0px');
          $(this).css('top',$('#banner').height()+10+'px');
          removeTransitionEffect();
        }
      });
      $('#footerTop').on('mouseup',function(event){
        $('#banner').toggle();
        resizePage();
      });
    }
    function removeTransitionEffect(){
      if($('#vidsDiv').css('top').substring(0,$('#vidsDiv').css('top').length-2)!=$('#banner').height()+10)setTimeout(removeTransitionEffect,100);
      else{
        console.log('removeTransitionEffect');
        $('#vidsDiv').css('transition','');
        $('#vidsDiv').css('-webkit-transition','');
      }
    }
    function resizePage(){
      //$('body').height($(window).height());
      pageConsole('window height: '+$(window).height());
      if(navigator.userAgent.indexOf('Nintendo WiiU')>0){
        // TODO remove once video is in detail overlay
        $('#video')[0].style.display='none';
        var vpString=$('meta[name=viewport]').attr('content');
        var vpHeight=-1;
        if($(window).height()>400){
          // initial WiiU resize 
          vpHeight=400;
        }
        if($(window).height()==400){
          // WiiU resize when getting ready for vid playback 
          vpHeight=350;
        }
        pageConsole(vpHeight);
        if(vpString.indexOf('height')==-1)vpString+=',height='+vpHeight;
        else vpString=vpString.substring(0,vpString.indexOf('height')+7)+vpHeight;
        $('meta[name=viewport]').attr('content',vpString);
      }
      //var remainder=$('#banner').height()*2;
      //$('#content').height($(window).height()-remainder);
      //$('#list').height($('#content').height()-$('#recent').height());
      //$('#content').height($(window).height()-$('#banner').height());
      $('#content').height($(window).height());
      $('#footer').width($(window).width()-20);
      $('#footerMain').width($('#footer').outerWidth()-$('#footerLeft').outerWidth()-$('#footerRight').outerWidth()-24); // TODO not sure why the 24 add is needed 
      $('#footer').height($(window).height()-10);
      $('#footerLeft').height($('#footer').height()-100);
      $('#footerRight').height($('#footer').height()-100);
      if($('#banner').css('display')=='none')$('#footer').css('top','10px');
      else{
        console.log($(window).height());
        console.log($('#content').height());
        console.log($('#banner').height());
        //var top=$(window).height()-remainder;
        var top=$(window).height()-$('#banner').height();
        console.log('resizePage: footer top '+top);
        $('#footer').css('top',top);
      }
      popcorn.video.height=$(window).height()/2.5;
      popcorn.video.width=popcorn.video.height*1.8;
      //$('#userAgent').text(navigator.userAgent); 
    }
    function addPopcornEvents(){
      // http://popcornjs.org/popcorn-docs/events/
      popcorn.on('abort',function(){
        console.log('abort');
      });
      popcorn.on('dataunavailable',function(){
        console.log('dataunavailable');
      });
      popcorn.on('durationchange',function(){
        console.log('durationchange');
      });
      popcorn.on('ended',function(){
        console.log('video has ended');
      });
      popcorn.on('emptied',function(){
        console.log('emptied');
        playing=false;
      });
      popcorn.on('empty',function(){
        console.log('empty');
      });
      popcorn.on('ended',function(){
        console.log('ended');
      });
      popcorn.on('error',function(event){
        // http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#error-codes
        console.log('error');
        console.log(event.srcElement.error);
      });
      popcorn.on('loadeddata',function(){
        console.log('loadeddata');
      });
      popcorn.on('loadedmetadata',function(){
        console.log('loadedmetadata');
        popcorn.media.currentTime=currentVid.timePlayed;
      });
      popcorn.on('pause',function(){
        console.log('pause');
        playing=false;
      });
      popcorn.on('playing',function(event){
        console.log('playing');
        playing=true;
        
      });
      popcorn.on('progress',function(event){
        //console.log('progress');
      });
      popcorn.on('suspend',function(){
        //console.log('suspend');
      });
      popcorn.on('timeupdate',function(){
        //console.log('timeupdate');
      });
      popcorn.on('waiting',function(){
        console.log('waiting');
      });
    }
    function pageConsole(text){
      jQuery('<div/>',{
        id:'consoleDiv',
        text:text
      }).addClass('consoleText').appendTo($('#console'));
      if($('#console').children().length>8){
        $('#console').children().first().empty();
        $('#console').children().first().remove();
      }
    }
    function toggleVolume(vol){
      if(vol!=0){
        volume=document.getElementById('video').volume;
        document.getElementById('video').volume=0;
      }else document.getElementById('video').volume=volume;
    }
    function fullscreen(){
      console.log('fullscreen');
      $('body')[0].webkitRequestFullScreen();
    }
    //document.addEventListener('DOMContentLoaded',function(){},false);
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="toplevelDirs" class="dirsDiv">
        <div id="initialDir" class="dirDiv">Begin directory navigation</div>
      </div>
    </div>
    <div id="content">
      <div id="list">
        <div id="vidsDiv" style="display:none;" class="vidsDiv"></div>
      </div>
      <div id="footer">
        <div id="footerTop" class="footerTop"></div>
        <div id="footerLeft" class="footerLeft"></div>
        <div id="footerMain" class="footerMain">
          <video id="video" controls>
            <source src=""></source>
            Please update your browser (video element is unsupported).
          </video>
          <div id="vidDetails">No metadata has been found for this video.</div>
          <div id="vidcontrols" style="display:none;">
            <button onclick="document.getElementById('video').play();">Play</button>
            <button onclick="document.getElementById('video').pause();">Pause</button>
            <button onclick="document.getElementById('video').volume+=0.1;">Volume+</button>
            <button onclick="toggleVolume(document.getElementById('video').volume);">Mute</button>
            <button onclick="document.getElementById('video').volume-=0.1;">Volume-</button>
            <!-- <button onclick="document.getElementById('video').pause();document.getElementById('video').src='';">Stop</button> -->
            <button onclick="document.getElementById('video').pause();">Stop</button>
          </div>
          <!-- <div id="footnote" style="display:none;"></div> -->
        </div>
        <div id="footerRight" class="footerRight"></div>
      </div>
    </div>
    <div id="console"></div>
    <div id="fullscreen" onclick="fullscreen();">Request fullscreen</div>
  </body>
</html>